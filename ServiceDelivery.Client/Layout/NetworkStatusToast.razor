@inject IJSRuntime JS
@inject NetworkStatusService NetworkStatusService

@if (!string.IsNullOrEmpty(_message))
{
    <div class="network-toast @(_isOnline ? "online" : "offline")">
        @_message
    </div>
}

@code {
    private string? _message;
    private bool _isOnline;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Get initial network status without triggering a toast
            _isOnline = await JS.InvokeAsync<bool>("networkStatusInterop.getOnlineStatus");
            await NetworkStatusService.SetOnlineStatus(_isOnline);
            NetworkStatusService.OnStatusChanged += ShowToast;

            // Then start listening for changes
            await JS.InvokeVoidAsync("networkStatusInterop.init", DotNetObjectReference.Create(this));
        }
    }

    [JSInvokable]
    public async Task SetNetworkStatus(bool isOnline)
    {
        await NetworkStatusService.SetOnlineStatus(isOnline);
    }

    private async Task ShowToast()
    {
        _isOnline = NetworkStatusService.IsOnline;
        _message = _isOnline ? "✅ You are back online!" : "⚠️ You are offline.";
        StateHasChanged();

        await Task.Delay(2000);
        _message = null;
        await InvokeAsync(StateHasChanged);
    }
}
